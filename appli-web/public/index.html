<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Gestion des tâches</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      margin-top: 0;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }
    input, select, textarea, button {
      padding: 8px;
      font-size: 0.9rem;
      width: 100%;
      box-sizing: border-box;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 4px;
    }
    button.primary {
      background: #2563eb;
      color: white;
    }
    button.danger {
      background: #dc2626;
      color: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #e5e5e5;
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f3f4f6;
    }
    .status-TODO {
      color: #92400e;
      font-weight: bold;
    }
    .status-IN_PROGRESS {
      color: #1d4ed8;
      font-weight: bold;
    }
    .status-DONE {
      color: #059669;
      font-weight: bold;
    }
    .small {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .actions {
      display: flex;
      gap: 4px;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gestion des tâches</h1>
    <p class="small">
      Backend: <code>Node.js / Express</code> – DB: <code>MySQL RDS</code> – Port: <code>8080</code>
    </p>

    <h2>Créer une nouvelle tâche</h2>
    <form id="task-form">
      <div>
        <label for="user_id">ID utilisateur (user_id)</label>
        <input type="number" id="user_id" name="user_id" required>
      </div>
      <div>
        <label for="title">Titre</label>
        <input type="text" id="title" name="title" required>
      </div>
      <div>
        <label for="status">Statut</label>
        <select id="status" name="status">
          <option value="TODO">TODO</option>
          <option value="IN_PROGRESS">En cours</option>
          <option value="DONE">Terminé</option>
        </select>
      </div>
      <div>
        <label for="due_date">Échéance (YYYY-MM-DD)</label>
        <input type="date" id="due_date" name="due_date">
      </div>
      <div style="grid-column: 1 / -1;">
        <label for="description">Description</label>
        <textarea id="description" name="description"></textarea>
      </div>
      <div style="grid-column: 1 / -1; text-align: right;">
        <button type="submit" class="primary">Créer la tâche</button>
      </div>
    </form>

    <h2>Liste des tâches</h2>
    <div id="tasks-container">
      <p class="small">Chargement des tâches...</p>
    </div>
  </div>

  <script>
    const tasksContainer = document.getElementById('tasks-container');
    const form = document.getElementById('task-form');

    async function fetchTasks() {
      tasksContainer.innerHTML = '<p class="small">Chargement des tâches...</p>';
      try {
        const res = await fetch('/tasks');
        if (!res.ok) throw new Error('Erreur HTTP ' + res.status);
        const tasks = await res.json();
        renderTasks(tasks);
      } catch (err) {
        console.error(err);
        tasksContainer.innerHTML = '<p style="color:red;">Erreur lors du chargement des tâches.</p>';
      }
    }

    function renderTasks(tasks) {
      if (!tasks.length) {
        tasksContainer.innerHTML = '<p class="small">Aucune tâche pour le moment.</p>';
        return;
      }

      let html = '<table>';
      html += `
        <thead>
          <tr>
            <th>ID</th>
            <th>Titre</th>
            <th>Utilisateur</th>
            <th>Statut</th>
            <th>Échéance</th>
            <th>Dates</th>
            <th>Description</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
      `;

      for (const t of tasks) {
        html += `
          <tr data-id="${t.id}">
            <td>${t.id}</td>
            <td>${escapeHtml(t.title || '')}</td>
            <td>
              ${escapeHtml(t.user_name || '')}<br>
              <span class="small">${escapeHtml(t.user_email || '')}</span>
            </td>
            <td>
              <span class="badge status-${t.status}">${t.status}</span><br>
              <select onchange="updateStatus(${t.id}, this.value)">
                <option value="TODO" ${t.status === 'TODO' ? 'selected' : ''}>TODO</option>
                <option value="IN_PROGRESS" ${t.status === 'IN_PROGRESS' ? 'selected' : ''}>En cours</option>
                <option value="DONE" ${t.status === 'DONE' ? 'selected' : ''}>Terminé</option>
              </select>
            </td>
            <td>${t.due_date ? escapeHtml(t.due_date) : '<span class="small">—</span>'}</td>
            <td class="small">
              Créée: ${t.created_at || ''}<br>
              Modifiée: ${t.updated_at || ''}
            </td>
            <td>${t.description ? escapeHtml(t.description) : '<span class="small">—</span>'}</td>
            <td>
              <div class="actions">
                <button class="danger" onclick="deleteTask(${t.id})">Supprimer</button>
              </div>
            </td>
          </tr>
        `;
      }

      html += '</tbody></table>';
      tasksContainer.innerHTML = html;
    }

    // Création d'une tâche
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const payload = {
        user_id: Number(form.user_id.value),
        title: form.title.value,
        description: form.description.value || null,
        status: form.status.value,
        due_date: form.due_date.value || null
      };

      try {
        const res = await fetch('/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'Erreur HTTP ' + res.status);
        }

        form.reset();
        form.status.value = 'TODO';
        fetchTasks();
      } catch (err) {
        alert('Erreur lors de la création: ' + err.message);
      }
    });

    // Mise à jour du statut
    async function updateStatus(id, newStatus) {
      try {
        const res = await fetch('/tasks/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'Erreur HTTP ' + res.status);
        }
        fetchTasks();
      } catch (err) {
        alert('Erreur lors de la mise à jour: ' + err.message);
      }
    }

    // Suppression d'une tâche
    async function deleteTask(id) {
      if (!confirm('Supprimer la tâche #' + id + ' ?')) return;
      try {
        const res = await fetch('/tasks/' + id, {
          method: 'DELETE'
        });
        if (!res.ok && res.status !== 204) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'Erreur HTTP ' + res.status);
        }
        fetchTasks();
      } catch (err) {
        alert('Erreur lors de la suppression: ' + err.message);
      }
    }

    // Simple échappement HTML pour éviter l'injection
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // Rendre les fonctions globales pour qu'elles soient appelables depuis le HTML
    window.updateStatus = updateStatus;
    window.deleteTask = deleteTask;

    // Chargement initial
    fetchTasks();
  </script>
</body>
</html>
